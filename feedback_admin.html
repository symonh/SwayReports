<!doctype html>
<html lang="en" class="dark-mode">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Sway Feedback Admin</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.2/darkly/bootstrap.min.css" id="theme-css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <style>
    :root {
      /* Darkened dark mode theme */
      --bg-color: #050505;          /* Near-black background */
      --card-bg: #0e0e1a;           /* Deeper navy card */
      --card-header-bg: #141422;     /* Darker header */
      --text-color: #e4e6eb;
      --muted-text-color: #a9adc1;
      --border-color: #1f1f2d;
      --button-bg: #252538;
      --button-hover-bg: #3a3a59; 
      --primary-color: #8a8aff;
      --link-color: #a3a3ff;
      --input-bg: #252538;
      --highlight-bg: rgba(138, 138, 255, 0.1);
      --danger-color: #ff5e5e;
      --success-color: #4caf50;
    }

    /* Light mode theme variables */
    html.light-mode {
      /* Base colors */
      --bg-color: #f5f7fa;
      --card-bg: #ffffff;
      --card-header-bg: #f0f5fc;
      --text-color: #2c3e50;
      --muted-text-color: #5a6a7e;
      --border-color: #d1d9e6;
      --link-color: #2c3e50;
      
      /* UI elements - using purple theme */
      --button-bg: #eef2f7; 
      --button-hover-bg: #d9e2ec;
      --primary-color: #23004D; 
      --input-bg: #ffffff;
      --highlight-bg: rgba(35, 0, 77, 0.05);
      --danger-color: #dc3545;
      --success-color: #28a745;
    }
    
    body { 
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      padding: 0;
      margin: 0;
    }

    .header {
      background-color: var(--card-header-bg);
      padding: 1.5rem 0;
      margin-bottom: 2rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-weight: 700;
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .header p {
      font-size: 1.1rem;
      color: var(--muted-text-color);
      margin: 0;
    }

    .container {
      max-width: 1200px;
      padding: 0 1rem;
    }

    .card {
      background-color: var(--card-bg);
      border: none;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }

    .card-header {
      background-color: var(--card-header-bg);
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      padding: 1rem 1.5rem;
    }

    .card-body {
      padding: 1.5rem;
    }

    .form-control {
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
    }

    .form-control:focus {
      background-color: var(--input-bg);
      border-color: var(--primary-color);
      color: var(--text-color);
      box-shadow: 0 0 0 0.2rem rgba(138, 138, 255, 0.25);
    }

    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-primary:hover {
      background-color: var(--button-hover-bg);
      border-color: var(--button-hover-bg);
    }

    .btn-danger {
      background-color: var(--danger-color);
      border-color: var(--danger-color);
    }

    .category-badge {
      background-color: var(--highlight-bg);
      color: var(--primary-color);
      padding: 0.35rem 0.75rem;
      border-radius: 50px;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      display: inline-block;
      font-size: 0.85rem;
    }

    .category-badge .remove-category {
      margin-left: 0.5rem;
      cursor: pointer;
    }

    .feedback-item {
      background-color: var(--highlight-bg);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
    }

    .feedback-text {
      margin-bottom: 0.5rem;
      padding-right: 2rem;
    }

    .feedback-categories {
      display: flex;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }

    .delete-feedback {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      color: var(--danger-color);
      cursor: pointer;
      opacity: 0.7;
    }

    .delete-feedback:hover {
      opacity: 1;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .theme-toggle {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background-color: var(--card-bg);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 100;
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
    }

    .theme-toggle i {
      font-size: 1.5rem;
      color: var(--text-color);
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }

    .notification.success {
      background-color: var(--success-color);
    }

    .notification.error {
      background-color: var(--danger-color);
    }

    .notification.show {
      opacity: 1;
    }

    #loginForm {
      max-width: 400px;
      margin: 50px auto;
    }

    .auth-screen {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .login-card {
      width: 400px;
      padding: 2rem;
    }

    .nav-tabs {
      border-color: var(--border-color);
    }

    .nav-tabs .nav-link {
      color: var(--muted-text-color);
      border: none;
      padding: 0.75rem 1.25rem;
    }

    .nav-tabs .nav-link.active {
      color: var(--primary-color);
      background-color: transparent;
      border-bottom: 2px solid var(--primary-color);
    }

    .tab-content {
      padding-top: 1.5rem;
    }
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div id="authScreen" class="auth-screen">
    <div class="card login-card">
      <h3 class="text-center mb-4">Sway Feedback Admin</h3>
      <div id="loginError" class="alert alert-danger d-none" role="alert"></div>
      <form id="loginForm">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block mb-3">Login</button>
        <button type="button" id="googleLoginBtn" class="btn btn-light btn-block">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" height="18" class="mr-2">
          Sign in with Google
        </button>
      </form>
    </div>
  </div>

  <!-- Main Admin Interface -->
  <div id="adminInterface" class="d-none">
    <div class="header">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1>Sway Feedback Admin</h1>
            <p>Manage student feedback and categories</p>
          </div>
          <div>
            <span id="userEmail" class="mr-3 text-muted"></span>
            <button id="logoutBtn" class="btn btn-outline-light">Logout</button>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <div class="col-12">
          <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <a class="nav-link active" id="feedbacks-tab" data-toggle="tab" href="#feedbacks" role="tab">
                Manage Feedback
              </a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="categories-tab" data-toggle="tab" href="#categories" role="tab">
                Manage Categories
              </a>
            </li>
          </ul>

          <div class="tab-content" id="adminTabsContent">
            <!-- Feedbacks Tab -->
            <div class="tab-pane fade show active" id="feedbacks" role="tabpanel">
              <div class="card">
                <div class="card-header">Add New Feedback</div>
                <div class="card-body">
                  <form id="addFeedbackForm">
                    <div class="form-group">
                      <label for="feedbackText">Feedback Text</label>
                      <textarea id="feedbackText" class="form-control" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                      <label>Categories</label>
                      <div id="categoryCheckboxes" class="row">
                        <!-- Category checkboxes will be added here dynamically -->
                        <div class="loading">
                          <div class="loading-spinner"></div>
                        </div>
                      </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Feedback</button>
                  </form>
                </div>
              </div>

              <div class="card">
                <div class="card-header">All Feedback</div>
                <div class="card-body">
                  <div id="feedbackList">
                    <!-- Feedback items will be added here dynamically -->
                    <div class="loading">
                      <div class="loading-spinner"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Categories Tab -->
            <div class="tab-pane fade" id="categories" role="tabpanel">
              <div class="card">
                <div class="card-header">Add New Category</div>
                <div class="card-body">
                  <form id="addCategoryForm">
                    <div class="form-group">
                      <label for="categoryName">Category Name</label>
                      <input type="text" id="categoryName" class="form-control" required>
                    </div>
                    <div class="form-group">
                      <label for="categorySlug">Category ID (slug)</label>
                      <input type="text" id="categorySlug" class="form-control" required>
                      <small class="form-text text-muted">Use lowercase letters, numbers, and hyphens only (e.g., "shy-students")</small>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                  </form>
                </div>
              </div>

              <div class="card">
                <div class="card-header">All Categories</div>
                <div class="card-body">
                  <div id="categoryList">
                    <!-- Categories will be added here dynamically -->
                    <div class="loading">
                      <div class="loading-spinner"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmationModalLabel">Confirm Action</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" id="confirmationModalBody">
          Are you sure you want to proceed?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <div class="theme-toggle" id="theme-toggle">
    <i class="fas fa-moon"></i>
  </div>

  <div id="notification" class="notification"></div>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    // Import Firebase configuration and functions
    import { 
      loadCategoriesFromFirebase,
      loadFeedbackFromFirebase,
      addCategoryToFirebase,
      addFeedbackToFirebase,
      deleteCategoryFromFirebase,
      deleteFeedbackFromFirebase
    } from './firebase-config.js';
    
    // Auth State
    let currentUser = null;
    let currentAction = null;
    let actionParam = null;

    // DOM Elements
    const authScreen = document.getElementById('authScreen');
    const adminInterface = document.getElementById('adminInterface');
    const loginForm = document.getElementById('loginForm');
    const googleLoginBtn = document.getElementById('googleLoginBtn');
    const loginError = document.getElementById('loginError');
    const logoutBtn = document.getElementById('logoutBtn');
    const userEmail = document.getElementById('userEmail');
    const addFeedbackForm = document.getElementById('addFeedbackForm');
    const addCategoryForm = document.getElementById('addCategoryForm');
    const categoryCheckboxes = document.getElementById('categoryCheckboxes');
    const feedbackList = document.getElementById('feedbackList');
    const categoryList = document.getElementById('categoryList');
    const notification = document.getElementById('notification');
    const confirmationModal = $('#confirmationModal');
    const confirmationModalBody = document.getElementById('confirmationModalBody');
    const confirmActionBtn = document.getElementById('confirmActionBtn');

    // Handle Login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      try {
        // For local testing, use this simple auth
        if (email === 'admin@sway.app' && password === 'admin123') {
          currentUser = { email };
          showNotification('Logged in successfully', 'success');
          showAdminInterface();
          return;
        }
        
        // Use Firebase authentication in production
        await firebase.auth().signInWithEmailAndPassword(email, password);
        currentUser = firebase.auth().currentUser;
        showNotification('Logged in successfully', 'success');
        showAdminInterface();
      } catch (error) {
        loginError.textContent = error.message || 'Invalid email or password';
        loginError.classList.remove('d-none');
      }
    });

    // Handle Google Login
    googleLoginBtn.addEventListener('click', async () => {
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({
          hd: 'swaybeta.ai' // Limit to Sway organization emails
        });
        await firebase.auth().signInWithPopup(provider);
      } catch (error) {
        loginError.textContent = error.message;
        loginError.classList.remove('d-none');
      }
    });

    // Handle Logout
    logoutBtn.addEventListener('click', () => {
      showConfirmationModal(
        'Are you sure you want to logout?',
        async () => {
          try {
            // For local testing
            if (currentUser && !firebase.auth().currentUser) {
              currentUser = null;
              showAuthScreen();
              showNotification('Logged out successfully', 'success');
              return;
            }
            
            // For production
            await firebase.auth().signOut();
            currentUser = null;
            showAuthScreen();
            showNotification('Logged out successfully', 'success');
          } catch (error) {
            console.error('Error signing out:', error);
            showNotification('Error signing out', 'error');
          }
        }
      );
    });

    // Check Firebase Auth State
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        showAdminInterface();
      } else {
        if (!currentUser || currentUser.email === 'admin@sway.app') {
          // Only redirect to login if not the test user
          currentUser = null;
          showAuthScreen();
        }
      }
    });

    // Show confirmation modal
    function showConfirmationModal(message, callback) {
      confirmationModalBody.textContent = message;
      currentAction = callback;
      confirmationModal.modal('show');
    }

    // Handle confirmation
    confirmActionBtn.addEventListener('click', () => {
      confirmationModal.modal('hide');
      if (currentAction) {
        currentAction(actionParam);
        currentAction = null;
        actionParam = null;
      }
    });

    // Handle Theme Toggle
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = themeToggle.querySelector('i');
    const htmlElement = document.documentElement;
    
    themeToggle.addEventListener('click', function() {
      if (htmlElement.classList.contains('light-mode')) {
        htmlElement.classList.remove('light-mode');
        themeIcon.classList.remove('fa-sun');
        themeIcon.classList.add('fa-moon');
        localStorage.setItem('theme', 'dark');
      } else {
        htmlElement.classList.add('light-mode');
        themeIcon.classList.remove('fa-moon');
        themeIcon.classList.add('fa-sun');
        localStorage.setItem('theme', 'light');
      }
    });

    // Check saved theme preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
      htmlElement.classList.add('light-mode');
      themeIcon.classList.remove('fa-moon');
      themeIcon.classList.add('fa-sun');
    }

    // Show notification
    function showNotification(message, type) {
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // UI state management
    function showAuthScreen() {
      authScreen.classList.remove('d-none');
      adminInterface.classList.add('d-none');
    }

    function showAdminInterface() {
      authScreen.classList.add('d-none');
      adminInterface.classList.remove('d-none');
      if (currentUser) {
        userEmail.textContent = currentUser.email || '';
      }
      loadCategories();
      loadFeedback();
    }

    // Load categories
    async function loadCategories() {
      try {
        const categories = await loadCategoriesFromFirebase();
        
        // Update category checkboxes
        categoryCheckboxes.innerHTML = '';
        categories.forEach(category => {
          const col = document.createElement('div');
          col.className = 'col-md-4 mb-2';
          col.innerHTML = `
            <div class="custom-control custom-checkbox">
              <input type="checkbox" class="custom-control-input" id="cat-${category.id}" value="${category.id}" data-name="${category.name}">
              <label class="custom-control-label" for="cat-${category.id}">${category.name}</label>
            </div>
          `;
          categoryCheckboxes.appendChild(col);
        });
        
        // Update category list
        categoryList.innerHTML = '';
        categories.forEach(category => {
          const categoryElem = document.createElement('div');
          categoryElem.className = 'category-badge';
          categoryElem.innerHTML = `
            ${category.name}
            <span class="remove-category" data-id="${category.id}"><i class="fas fa-times"></i></span>
          `;
          categoryList.appendChild(categoryElem);
        });
        
        // Set up delete handlers
        document.querySelectorAll('.remove-category').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const categoryId = e.currentTarget.getAttribute('data-id');
            actionParam = categoryId;
            showConfirmationModal(
              `Are you sure you want to delete the "${categoryId}" category? This will also remove it from all feedback items.`,
              deleteCategory
            );
          });
        });
      } catch (error) {
        console.error('Error loading categories:', error);
        showNotification('Error loading categories', 'error');
      }
    }

    // Load feedback
    async function loadFeedback() {
      try {
        const feedbacks = await loadFeedbackFromFirebase();
        
        feedbackList.innerHTML = '';
        feedbacks.forEach(feedback => {
          const feedbackElem = document.createElement('div');
          feedbackElem.className = 'feedback-item';
          
          let categoriesHTML = '';
          feedback.categories.forEach(catId => {
            const checkbox = document.querySelector(`#cat-${catId}`);
            const catName = checkbox ? checkbox.getAttribute('data-name') : catId;
            categoriesHTML += `<span class="category-badge">${catName}</span>`;
          });
          
          feedbackElem.innerHTML = `
            <div class="feedback-text">${feedback.text}</div>
            <div class="feedback-categories">${categoriesHTML}</div>
            <div class="delete-feedback" data-id="${feedback.id}"><i class="fas fa-trash"></i></div>
          `;
          feedbackList.appendChild(feedbackElem);
        });
        
        // Set up delete handlers
        document.querySelectorAll('.delete-feedback').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const feedbackId = e.currentTarget.getAttribute('data-id');
            actionParam = feedbackId;
            showConfirmationModal(
              'Are you sure you want to delete this feedback?',
              deleteFeedback
            );
          });
        });
      } catch (error) {
        console.error('Error loading feedback:', error);
        showNotification('Error loading feedback', 'error');
      }
    }

    // Add new feedback
    addFeedbackForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const feedbackText = document.getElementById('feedbackText').value;
      const selectedCategories = Array.from(
        document.querySelectorAll('#categoryCheckboxes input[type="checkbox"]:checked')
      ).map(cb => cb.value);
      
      if (selectedCategories.length === 0) {
        showNotification('Please select at least one category', 'error');
        return;
      }
      
      try {
        await addFeedbackToFirebase(feedbackText, selectedCategories);
        showNotification('Feedback added successfully', 'success');
        document.getElementById('feedbackText').value = '';
        document.querySelectorAll('#categoryCheckboxes input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
        });
        loadFeedback();
      } catch (error) {
        console.error('Error adding feedback:', error);
        showNotification('Error adding feedback', 'error');
      }
    });

    // Add new category
    addCategoryForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const categoryName = document.getElementById('categoryName').value;
      let categorySlug = document.getElementById('categorySlug').value.trim();
      
      // If slug is empty, generate from name
      if (!categorySlug) {
        categorySlug = categoryName.toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');
        document.getElementById('categorySlug').value = categorySlug;
      }
      
      // Validate slug format
      if (!/^[a-z0-9-]+$/.test(categorySlug)) {
        showNotification('Category ID should only contain lowercase letters, numbers, and hyphens', 'error');
        return;
      }
      
      try {
        await addCategoryToFirebase(categoryName, categorySlug);
        showNotification('Category added successfully', 'success');
        document.getElementById('categoryName').value = '';
        document.getElementById('categorySlug').value = '';
        loadCategories();
      } catch (error) {
        console.error('Error adding category:', error);
        showNotification('Error adding category', 'error');
      }
    });

    // Generate slug from category name
    document.getElementById('categoryName').addEventListener('input', (e) => {
      const slugInput = document.getElementById('categorySlug');
      if (!slugInput.value.trim()) {
        const slug = e.target.value.toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');
        slugInput.value = slug;
      }
    });

    // Delete feedback
    async function deleteFeedback(id) {
      try {
        await deleteFeedbackFromFirebase(id);
        showNotification('Feedback deleted successfully', 'success');
        loadFeedback();
      } catch (error) {
        console.error('Error deleting feedback:', error);
        showNotification('Error deleting feedback', 'error');
      }
    }

    // Delete category
    async function deleteCategory(id) {
      try {
        await deleteCategoryFromFirebase(id);
        showNotification('Category deleted successfully', 'success');
        loadCategories();
        loadFeedback();
      } catch (error) {
        console.error('Error deleting category:', error);
        showNotification('Error deleting category', 'error');
      }
    }
  </script>
</body>
</html> 