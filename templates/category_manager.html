<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sway Reports Category Manager</title>
    <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.2/darkly/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #000000;
            --card-header-bg: #0f0f19;
            --text-color: #ffffff;
            --muted-text-color: #a9adc1;
            --border-color: #252538;
            --button-bg: #252538;
            --button-hover-bg: #3a3a59;
            --primary-color: #8a8aff;
            --link-color: #a3a3ff;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            padding: 0;
            margin: 0;
            min-height: 100vh;
        }
        
        .header {
            background-color: var(--card-header-bg);
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            font-weight: 700;
            color: var(--primary-color);
            background: linear-gradient(90deg, #8a8aff, #ff8a8a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            letter-spacing: -0.01em;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card-header {
            background-color: var(--card-header-bg);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #7575e6;
            border-color: #7575e6;
        }
        
        .report-item {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }
        
        .report-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }
        
        .report-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .category-badge {
            background-color: var(--button-bg);
            color: var(--text-color);
            padding: 0.3rem 0.7rem;
            border-radius: 50px;
            font-size: 0.8rem;
        }
        
        .report-description {
            font-size: 0.9rem;
            color: var(--muted-text-color);
            margin-bottom: 0.8rem;
        }
        
        .form-control {
            background-color: var(--button-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        
        .form-control:focus {
            background-color: var(--button-bg);
            color: var(--text-color);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(138, 138, 255, 0.25);
        }
        
        .custom-select {
            background-color: var(--button-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        
        .category-list-group .list-group-item {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        
        .sticky-top {
            top: 20px;
        }
        
        /* Drag and drop styles */
        .drag-handle {
            cursor: grab;
            color: var(--muted-text-color);
            position: absolute;
            right: 10px;
            top: 10px;
            transition: color 0.2s;
        }
        
        .drag-handle:hover {
            color: var(--primary-color);
        }
        
        .report-item.dragging {
            opacity: 0.5;
            border: 2px dashed var(--primary-color);
        }
        
        .report-item.drag-over {
            border: 2px dashed var(--primary-color);
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        
        .reports-container {
            min-height: 200px;
        }
        
        .save-order-feedback {
            display: none;
            color: #28a745;
            margin-left: 10px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1 class="text-center">Sway Reports Category Manager</h1>
        </div>
    </div>
    
    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="sticky-top">
                    <!-- Category Management -->
                    <div class="card">
                        <div class="card-header">
                            Manage Categories
                        </div>
                        <div class="card-body">
                            <!-- Add Category Form -->
                            <form action="/categories" method="post">
                                <input type="hidden" name="action" value="add">
                                <div class="form-group">
                                    <label for="new-category">Add New Category</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="new-category" name="new_category" placeholder="New category name">
                                        <div class="input-group-append">
                                            <button type="submit" class="btn btn-primary">Add</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            
                            <!-- Rename Category Form -->
                            <form action="/categories" method="post" class="mt-4">
                                <input type="hidden" name="action" value="rename">
                                <div class="form-group">
                                    <label for="old-category">Rename Category</label>
                                    <select name="old_category" id="old-category" class="custom-select mb-2">
                                        {% for category in categories %}
                                        <option value="{{ category }}">{{ category|replace('-', ' ')|title }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="new_category" placeholder="New name">
                                        <div class="input-group-append">
                                            <button type="submit" class="btn btn-warning">Rename</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            
                            <!-- Delete Category Form -->
                            <form action="/categories" method="post" class="mt-4">
                                <input type="hidden" name="action" value="delete">
                                <div class="form-group">
                                    <label for="delete-category">Delete Category</label>
                                    <div class="input-group">
                                        <select name="category" id="delete-category" class="custom-select">
                                            {% for category in categories %}
                                            <option value="{{ category }}">{{ category|replace('-', ' ')|title }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="input-group-append">
                                            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this category? It will be removed from all reports.')">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Existing Categories -->
                    <div class="card mt-4">
                        <div class="card-header">
                            Existing Categories
                        </div>
                        <div class="card-body p-0">
                            <ul class="list-group category-list-group">
                                {% for category in categories %}
                                {% set ns = namespace(count=0) %}
                                {% for report in reports %}
                                  {% if category in report.categories %}
                                    {% set ns.count = ns.count + 1 %}
                                  {% endif %}
                                {% endfor %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    {{ category|replace('-', ' ')|title }}
                                    <span class="badge badge-primary badge-pill">
                                        {{ ns.count }}
                                    </span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    
                    <!-- View Showcase Link -->
                    <div class="text-center mt-4 mb-4">
                        <a href="./instructor_reports_showcase.html" target="_blank" class="btn btn-outline-primary">
                            <i class="fas fa-external-link-alt mr-1"></i> View Showcase
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <!-- Reports List -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Assign Categories to Reports ({{ reports|length }} Reports)</span>
                        <span class="save-order-feedback"><i class="fas fa-check"></i> Order saved!</span>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle mr-2"></i> <strong>New Feature:</strong> You can now drag and drop reports to change their order in the showcase. 
                            <span class="ml-2">Just grab the <i class="fas fa-grip-lines"></i> handle and drag to reposition.</span>
                        </div>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                            </div>
                            <input type="text" id="search-reports" class="form-control" placeholder="Search reports by title or description...">
                        </div>
                        
                        <div class="reports-container" id="reports-container">
                            {% for report in reports %}
                            {% set report_index = loop.index0 %}
                            <div class="report-item" id="report-{{ report_index }}" data-filename="{{ report.filename }}">
                                <i class="fas fa-grip-lines drag-handle" title="Drag to reorder"></i>
                                
                                <div class="d-flex align-items-center mb-1">
                                    <div class="report-title mb-0" id="title-display-{{ report_index }}">{{ report.title }}</div>
                                    <input type="text" class="form-control form-control-sm ml-2 title-edit-input" id="title-input-{{ report_index }}" value="{{ report.title }}" style="display:none; max-width: 350px;" autocomplete="off">
                                    <button type="button" class="btn btn-sm btn-outline-info ml-2" id="edit-title-btn-{{ report_index }}" title="Edit Title"><i class="fas fa-edit"></i></button>
                                    <span class="title-save-feedback text-success ml-2" style="display:none;"><i class="fas fa-check"></i> Saved!</span>
                                </div>
                                
                                <div class="report-description">{{ report.description|truncate(100) }}</div>
                                <form class="category-assign-form" data-filename="{{ report.filename }}" autocomplete="off" onsubmit="return false;">
                                    <div class="form-group">
                                        <label>Assign Categories:</label>
                                        <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 0.5rem;">
                                            {% for category in categories %}
                                            <div class="form-check" style="min-width: 150px;">
                                                <input class="form-check-input category-checkbox" type="checkbox" name="categories" id="cat-{{ report_index }}-{{ category }}" value="{{ category }}" {% if category in report.categories %}checked{% endif %}>
                                                <label class="form-check-label" for="cat-{{ report_index }}-{{ category }}">
                                                    {{ category|replace('-', ' ')|title }}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="category-save-feedback text-success" style="display:none; font-size: 0.9rem;">
                                        <i class="fas fa-check"></i> Categories saved!
                                    </div>
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Drag and drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            const reportsContainer = document.getElementById('reports-container');
            const reportItems = document.querySelectorAll('.report-item');
            let draggedItem = null;
            
            // Add drag events to each report item
            reportItems.forEach(item => {
                const dragHandle = item.querySelector('.drag-handle');
                
                dragHandle.addEventListener('mousedown', function(e) {
                    // Prevent text selection during drag
                    e.preventDefault();
                    
                    draggedItem = item;
                    item.classList.add('dragging');
                    
                    // Track mouse position and handle drag
                    document.addEventListener('mousemove', handleDrag);
                    document.addEventListener('mouseup', stopDrag);
                });
                
                // Handle drag enter/over/leave events for drop target highlighting
                item.addEventListener('dragenter', function(e) {
                    e.preventDefault();
                    if (item !== draggedItem) {
                        item.classList.add('drag-over');
                    }
                });
                
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                item.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    item.classList.remove('drag-over');
                });
            });
            
            function handleDrag(e) {
                if (!draggedItem) return;
                
                // Get mouse position
                const mouseY = e.clientY;
                
                // Get all items except the dragged one
                const items = [...document.querySelectorAll('.report-item:not(.dragging)')];
                
                // Find the item we're hovering over
                let closestItem = null;
                let closestOffset = Number.NEGATIVE_INFINITY;
                
                items.forEach(item => {
                    const box = item.getBoundingClientRect();
                    const offset = mouseY - box.top - box.height / 2;
                    
                    if (offset < 0 && offset > closestOffset) {
                        closestOffset = offset;
                        closestItem = item;
                    }
                });
                
                // Adjust drag styles
                items.forEach(item => item.classList.remove('drag-over'));
                if (closestItem) {
                    closestItem.classList.add('drag-over');
                }
                
                // Move the dragged item
                if (closestItem) {
                    reportsContainer.insertBefore(draggedItem, closestItem);
                } else {
                    reportsContainer.appendChild(draggedItem);
                }
            }
            
            function stopDrag() {
                if (!draggedItem) return;
                
                draggedItem.classList.remove('dragging');
                document.querySelectorAll('.report-item').forEach(item => {
                    item.classList.remove('drag-over');
                });
                
                // Remove mouse event listeners
                document.removeEventListener('mousemove', handleDrag);
                document.removeEventListener('mouseup', stopDrag);
                
                // Save the new order
                saveReportOrder();
                
                draggedItem = null;
            }
            
            function saveReportOrder() {
                const reportItems = document.querySelectorAll('.report-item');
                const reportOrder = Array.from(reportItems).map(item => item.dataset.filename);
                
                fetch('/api/reorder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        report_order: reportOrder
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const feedback = document.querySelector('.save-order-feedback');
                        feedback.style.display = 'inline';
                        
                        setTimeout(() => {
                            feedback.style.display = 'none';
                        }, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error saving report order:', error);
                });
            }
            
            // Search functionality
            const searchInput = document.getElementById('search-reports');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                
                reportItems.forEach(item => {
                    const title = item.querySelector('.report-title').textContent.toLowerCase();
                    const description = item.querySelector('.report-description').textContent.toLowerCase();
                    
                    if (title.includes(searchTerm) || description.includes(searchTerm)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        });
        
        // Category checkbox handling
        document.addEventListener('DOMContentLoaded', function() {
            // Handle checkbox changes for category assignment
            const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
            
            categoryCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const form = this.closest('.category-assign-form');
                    const reportFilename = form.dataset.filename;
                    const checkboxes = form.querySelectorAll('input[name="categories"]:checked');
                    const categories = Array.from(checkboxes).map(cb => cb.value);
                    const feedback = form.querySelector('.category-save-feedback');
                    
                    // Save the category assignment
                    fetch('/api/assign', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            filename: reportFilename,
                            categories: categories
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            feedback.style.display = 'block';
                            
                            setTimeout(() => {
                                feedback.style.display = 'none';
                            }, 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Error saving categories:', error);
                    });
                });
            });
        });
        
        // Title editing functionality
        document.addEventListener('DOMContentLoaded', function() {
            const editButtons = document.querySelectorAll('[id^="edit-title-btn-"]');
            
            editButtons.forEach(button => {
                const reportIndex = button.id.split('-').pop();
                const displayElement = document.getElementById(`title-display-${reportIndex}`);
                const inputElement = document.getElementById(`title-input-${reportIndex}`);
                const feedback = button.nextElementSibling;
                const form = button.closest('.report-item');
                const reportFilename = form.dataset.filename;
                
                // Handle edit button click
                button.addEventListener('click', function() {
                    displayElement.style.display = 'none';
                    inputElement.style.display = 'inline-block';
                    inputElement.focus();
                    inputElement.select();
                });
                
                // Handle input blur and Enter key
                inputElement.addEventListener('blur', saveTitle);
                inputElement.addEventListener('keydown', function(e) {
                    console.log('Keydown event:', e.key);
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
                
                function saveTitle() {
                    const newTitle = inputElement.value.trim();
                    
                    if (newTitle !== displayElement.textContent.trim()) {
                        // Save the title
                        fetch('/api/update_title', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                filename: reportFilename,
                                title: newTitle
                            }),
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                displayElement.textContent = newTitle;
                                feedback.style.display = 'inline';
                                
                                setTimeout(() => {
                                    feedback.style.display = 'none';
                                }, 2000);
                            }
                        })
                        .catch(error => {
                            console.error('Error saving title:', error);
                        });
                    }
                    
                    displayElement.style.display = 'block';
                    inputElement.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html> 