import os
import glob
import re
import sys
import time
import datetime
import base64

# Append custom path so config can be imported (if needed)
sys.path.append('/Users/simon/Documents/GitHub')

# Function to extract the generated title from the HTML content.
def extract_generated_title(html):
    match = re.search(r'<div\s+class="generated-title\s+text-info\s+mb-1">(.*?)</div>', html, flags=re.DOTALL)
    if match:
        return match.group(1).strip()
    return None

# Function to extract the completion deadline (UTC) from the HTML content.
def extract_completion_deadline(html):
    pattern = (r'<div\s+class="col-5\s+col-label">\s*Completion deadline:\s*</div>\s*'
               r'<div\s+class="col-7\s+col-value">.*?<span\s+class="utc-time"\s+data-utc-time="([^"]+)"')
    match = re.search(pattern, html, flags=re.DOTALL)
    if match:
        deadline_str = match.group(1).strip()
        try:
            deadline = datetime.datetime.strptime(deadline_str, "%Y-%m-%d %H:%M:%S%z")
            return deadline
        except Exception as e:
            print(f"Error parsing deadline '{deadline_str}':", e)
    return None

# Read the entire file and return the content within <body>...</body>
def extract_body(html):
    match = re.search(r"<body[^>]*>(.*?)</body>", html, flags=re.DOTALL|re.IGNORECASE)
    if match:
        return match.group(1).strip()
    return html

def main():
    # Look for all .html files in the "html" folder (excluding the output file if present there)
    report_files = [f for f in glob.glob("html/*.html") if os.path.basename(f) != "instructor_reports_with_titles.html"]
    if not report_files:
        print("No .html files found in the 'html' folder.")
        return

    file_info = []
    for filename in report_files:
        with open(filename, "r", encoding="utf-8") as f:
            content = f.read()
        title = extract_generated_title(content)
        if not title:
            title = os.path.basename(filename)  # fallback if title not found
        deadline = extract_completion_deadline(content)
        body_content = extract_body(content)
        # Base64-encode the full file content to embed exactly as-is.
        encoded_content = base64.b64encode(content.encode("utf-8")).decode("utf-8")
        file_info.append({
            "filename": filename,
            "title": title,
            "deadline": deadline,  # may be None if not found
            "data": encoded_content,
            "body": body_content  # not used in this version; we embed the full file via data URI
        })
        print(f"File: {filename}\n  Title: {title}\n  Deadline: {deadline}\n")
        time.sleep(0.2)

    # Create an offset-aware maximum datetime for sorting.
    max_dt = datetime.datetime(9999, 12, 31, tzinfo=datetime.timezone.utc)
    file_info.sort(key=lambda x: x["deadline"] if x["deadline"] is not None else max_dt)

    # Build the combined HTML file.
    html_parts = []
    html_parts.append("""<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Instructor Reports for Ian Cruise</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      scroll-behavior: smooth;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
      color: #333;
      display: flex;
    }
    /* Sidebar index */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 250px;
      height: 100%;
      background: #fff;
      border-right: 1px solid #ddd;
      overflow-y: auto;
      padding: 20px;
      box-sizing: border-box;
      z-index: 100;
    }
    .sidebar h2 {
      margin-top: 0;
      font-size: 1.2em;
    }
    .sidebar ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
    }
    .sidebar li {
      margin-bottom: 10px;
    }
    .sidebar a {
      text-decoration: none;
      color: #2c3e50;
      font-size: 0.95em;
    }
    .sidebar .deadline {
      font-size: 0.8em;
      color: #777;
    }
    /* Main container for reports */
    .container {
      margin-left: 250px;
      height: 100vh;
      overflow-y: scroll;
      scroll-snap-type: y mandatory;
      width: calc(100% - 250px);
    }
    .report-section {
      scroll-snap-align: start;
      height: 100vh;
      padding: 20px;
      box-sizing: border-box;
      border-bottom: 1px solid #ddd;
      position: relative;
      background: #fff;
    }
    .report-section h2 {
      margin-top: 0;
    }
    .deadline {
      font-size: 0.9em;
      color: #777;
      margin-bottom: 10px;
    }
    iframe {
      width: 100%;
      border: none;
      height: 100%;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Index</h2>
    <ul>
""")
    # Create sidebar index entries.
    for info in file_info:
        section_id = os.path.splitext(os.path.basename(info["filename"]))[0]
        deadline_str = info["deadline"].strftime("%Y-%m-%d %H:%M:%S %Z") if info["deadline"] else "No deadline"
        html_parts.append(f'      <li><a href="#{section_id}">{info["title"]}</a><br><span class="deadline">({deadline_str})</span></li>')
    html_parts.append("    </ul>\n  </div>\n")
    html_parts.append('<div class="container">')
    # Add each report section with embedded content via a data URI in an iframe.
    for info in file_info:
        section_id = os.path.splitext(os.path.basename(info["filename"]))[0]
        deadline_str = info["deadline"].strftime("%Y-%m-%d %H:%M:%S %Z") if info["deadline"] else "No deadline"
        html_parts.append(f'<section id="{section_id}" class="report-section">')
        html_parts.append(f'  <h2>{info["title"]}</h2>')
        html_parts.append(f'  <p class="deadline">Deadline: {deadline_str}</p>')
        html_parts.append(f'  <iframe src="data:text/html;base64,{info["data"]}"></iframe>')
        html_parts.append("</section>")
    html_parts.append("</div>")  # close container
    html_parts.append("</body>\n</html>")
    
    output_filename = "instructor_reports_with_titles.html"
    with open(output_filename, "w", encoding="utf-8") as f:
        f.write("\n".join(html_parts))
    
    print(f"Combined report created: {output_filename}")

if __name__ == "__main__":
    main()